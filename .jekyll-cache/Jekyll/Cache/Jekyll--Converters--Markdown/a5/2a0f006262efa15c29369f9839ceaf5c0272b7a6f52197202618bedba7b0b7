I"ӗ<ul id="markdown-toc">
  <li><a href="#requerimentos" id="markdown-toc-requerimentos">Requerimentos</a></li>
  <li><a href="#introdução" id="markdown-toc-introdução">Introdução</a></li>
  <li><a href="#preparando-o-básico" id="markdown-toc-preparando-o-básico">Preparando o básico</a></li>
  <li><a href="#o-fdisk" id="markdown-toc-o-fdisk">O fdisk</a>    <ul>
      <li><a href="#conceitos" id="markdown-toc-conceitos">Conceitos</a></li>
      <li><a href="#conhecendo-a-estrutura-de-partições" id="markdown-toc-conhecendo-a-estrutura-de-partições">Conhecendo a estrutura de partições</a></li>
      <li><a href="#usando-o-fdisk" id="markdown-toc-usando-o-fdisk">Usando o fdisk</a></li>
      <li><a href="#criando-a-partição-de-boot-com-fdisk" id="markdown-toc-criando-a-partição-de-boot-com-fdisk">Criando a partição de Boot com fdisk</a></li>
      <li><a href="#criando-partição-do-windows-com-fdisk" id="markdown-toc-criando-partição-do-windows-com-fdisk">Criando partição do Windows com fdisk</a></li>
      <li><a href="#criando-partição-linux-lvm-com-fdisk" id="markdown-toc-criando-partição-linux-lvm-com-fdisk">Criando partição “Linux LVM” com fdisk</a></li>
    </ul>
  </li>
  <li><a href="#o-luks" id="markdown-toc-o-luks">O LUKS</a>    <ul>
      <li><a href="#conceitos-1" id="markdown-toc-conceitos-1">Conceitos</a></li>
      <li><a href="#configurando-hostname" id="markdown-toc-configurando-hostname">Configurando hostname</a></li>
      <li><a href="#habilitando-rede-cabeada-durante-o-boot" id="markdown-toc-habilitando-rede-cabeada-durante-o-boot">Habilitando rede cabeada durante o boot</a></li>
      <li><a href="#criando-um-usuário-padrão" id="markdown-toc-criando-um-usuário-padrão">Criando um usuário padrão</a></li>
      <li><a href="#erro-aqui" id="markdown-toc-erro-aqui">Erro AQUI</a></li>
      <li><a href="#configurando-o-etcfstab" id="markdown-toc-configurando-o-etcfstab">Configurando o /etc/fstab</a></li>
      <li><a href="#configurando-o-etcmkinitcpioconf" id="markdown-toc-configurando-o-etcmkinitcpioconf">Configurando o /etc/mkinitcpio.conf</a></li>
    </ul>
  </li>
  <li><a href="#o-grub" id="markdown-toc-o-grub">O Grub</a>    <ul>
      <li><a href="#conceitos-2" id="markdown-toc-conceitos-2">Conceitos</a></li>
      <li><a href="#instalando-o-grub-no-sistema" id="markdown-toc-instalando-o-grub-no-sistema">Instalando o Grub no sistema</a></li>
      <li><a href="#configurando-o-grub" id="markdown-toc-configurando-o-grub">Configurando o Grub</a></li>
      <li><a href="#gerando-as-configurações" id="markdown-toc-gerando-as-configurações">Gerando as configurações</a></li>
      <li><a href="#instalando-o-grub-na-unidade" id="markdown-toc-instalando-o-grub-na-unidade">Instalando o Grub na unidade</a></li>
    </ul>
  </li>
  <li><a href="#reiniciando-o-sistema" id="markdown-toc-reiniciando-o-sistema">Reiniciando o sistema</a></li>
  <li><a href="#conclusão" id="markdown-toc-conclusão">Conclusão</a></li>
</ul>

<h1 id="requerimentos">Requerimentos</h1>

<ul>
  <li>Imagem do <a href="https://www.archlinux.org/download/" target="_blank">Archlinux</a> queimada em DVD ou Pendrive Bootável.</li>
  <li>Espaço livre no HD(SSD) ou usar <a href="https://www.virtualbox.org/" target="_blank">VirtualBox</a> para realizar esse tutorial.</li>
  <li>Conexão com a Internet.</li>
</ul>

<blockquote>
  <p>Nota: Não irei entrar em detalhe de como realizar o procedimento de gravação
de imagem ou como usar VirtualBox, não é o foco do tutorial.</p>
</blockquote>

<p>Se você for instalar o Archlinux em uma máquina mesmo, você vai precisar de um celular, tablet, notebook, ou até mesmo outro desktop para poder acompanhar esse tutorial. Isso porque você vai cair em uma “tela preta” de comandos, e realmente é só você e “ela”. Não tem um ambiente desktop para você acessar o navegador e pesquisar enquando instala igual outras distribuições.</p>

<h1 id="introdução">Introdução</h1>

<p>Uma das coisas mais temidas para quem usa um computador, pode se dizer que é os dados contido nele. Dependendo de qual informação você tem em sua máquina, isso pode comprometer (e muito) sua vida pessoal, no trabalho, etc.</p>

<p>Ter uma máquina com uma senha de login “forte”, <strong>N Ã O</strong> irá manter seus dados seguros de alguém que tenha um conhecimento não leigo. Vou enfatizar melhor com o seguinte exemplo qual seria esse conhecimento:</p>

<p><em>Imagine você com sua linda máquina onde seu(s) S.O estão instalados em partições (ou até mesmo em um HD/SSD completo) que não tem criptografia. Simplesmente a pessoa pega um S.O bootável (no pendrive ou DVD), inicia sua máquina com o mesmo, monta as partições e, “tcharamm”! Os dados de sua máquina estão expostos para esse indivíduo ‘esperto’.</em></p>

<p>Com base nesse pequeno exemplo acima, podemos pensar:</p>

<p><strong>E se você impedir que as partições sejam montadas através de um sistema bootável? E se para montar partições tivesse uma senha para isso?</strong></p>

<p>Bom, com o alocador de volumes LVM no Linux e criptografia LUKS, isso é possível! Eba :smirk:</p>

<p><a href="http://web.mit.edu/rhel-doc/3/rhel-sag-pt_br-3/ch-lvm-intro.html" target="_blank">LVM</a> permite a criação de partições com a possibilidade de redimencioná-las. O disco ou seu conjunto é alocado em um ou mais volumes. O LVM trabalha com volumes físcos que são combinados com grupos lógicos.</p>

<p><a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup" target="_blank">Luks</a> é uma especificação de criptografia de disco originalmente planejada para Linux.</p>

<p>Essa criptografia pode ser aplicada a qualquer distribuição Linux. Porem, os passos são diferentes de acordo com a instalação da distribuição. Mas o conceito é o mesmo.</p>

<p>Então, neste caso, para podermos utilizar esse conceito de criptografia e de alocamento de disco com o LVM, temos que passar pelo processo de instalação da distribuição. Então, vamos a instalação…</p>

<p><em>Archlinux! Eu escolho você!</em></p>

<h1 id="preparando-o-básico">Preparando o básico</h1>

<p>Já com o Archlinux em boot na máquina…</p>

<div class="row imager" style="margin: 40px 0px;">
            <img class="img-fluid mx-auto d-block" src="/assets/images/posts/instalando-archlinux-com-criptografia-luks-e-lvm/start_archlinux_boot.jpg" title="instalando-archlinux-com-criptografia-luks-e-lvm/start_archlinux_boot.jpg" alt="instalando-archlinux-com-criptografia-luks-e-lvm/start_archlinux_boot.jpg" />
          </div>

<p> a primeira coisa a se fazer é carregar o layout do teclado, para isso você precisa saber qual é o seu <a href="https://wiki.archlinux.org/index.php/KEYMAP_(Portugu%C3%AAs)" target="_blank">KEYMAP</a>.</p>

<p>Uma forma de fazer isso via console, é usando o comando abaixo para listar os layouts disponíveis:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>localectl list-keymaps
</pre></td></tr></tbody></table></code></pre></figure>

<p>No meu caso é <code class="highlighter-rouge">br-abnt2</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>loadkeys br-abnt2
</pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
  <p>Nota: Essa configuração é temporária, isso porque ainda não estamos com
o sistema Archlinux instalado para deixar permanente.</p>
</blockquote>

<p>Agora iremos carregar alguns módulos <strong>crypt</strong>, que iremos usar para realizar toda criptografia:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>modprobe <span class="nt">-a</span> dm-mod dm-crypt
</pre></td></tr></tbody></table></code></pre></figure>

<h1 id="o-fdisk">O fdisk</h1>

<h2 id="conceitos">Conceitos</h2>

<p>O <code class="highlighter-rouge">fdisk</code> é uma ferramenta indispensável para quem usa Archlinux. É com ela que criamos todas partições em nosso disco durante a instalação. O <code class="highlighter-rouge">fdisk</code> é baseado através de linhas de comandos, como isso, você pode achar um pouco complexo no começo, mas com tempo se acostuma. :laughing: Caso realmente não queira utilizar o <code class="highlighter-rouge">fdisk</code>, existe o cfdisk.</p>

<p>O <a href="https://en.wikipedia.org/wiki/Cfdisk" target="_blank">cfdisk</a>, é como se fosse um “fork” do <code class="highlighter-rouge">fdisk</code>, porem, baseado em uma interface usando as setas direcionais do teclado.</p>

<h2 id="conhecendo-a-estrutura-de-partições">Conhecendo a estrutura de partições</h2>

<p>Vamos começar a partir de agora, a trabalhar com o <code class="highlighter-rouge">fdisk</code> para a criação de partições. Mas antes de começar, devemos entender a estrutura de partições que devemos ou queremos ter na máquina.</p>

<p>Nessa instalação, vou usar a seguinte estrutura de 3(três) partições:</p>

<ul>
  <li>Uma para Linux Boot</li>
  <li>Uma para Windows</li>
  <li>Uma para Linux LVM</li>
</ul>

<p>Não sei quanto a você, mas eu uso <a href="https://www.microsoft.com/pt-br/windows/" target="_blank">Windows</a> e outras distribuições Linux em outras partições na minha máquina, então já vou aproveitar e deixar essa intalação com esse tipo de ambiente.</p>

<p>Caso você não utilize Windows e nem outras distribuições Linux, você simplesmente deve realizar a criação da partição de <strong>Linux Boot</strong> e uma para <strong>Linux LVM</strong>.</p>

<p>Como vamos utilizar <strong>LVM</strong> na partição Linux, nessa mesma partição podemos expandir outros volumes lógicos, ou seja, outras distribuições Linux dentro dessa partição do tipo LVM podem ser criadas (desde que exista espaço).</p>

<h2 id="usando-o-fdisk">Usando o fdisk</h2>

<p>Primeira coisa a se fazer antes de usar o o <code class="highlighter-rouge">fdisk</code>, é obter as informações de nosso disco rígido, listando o mesmo para ver se encontra partições ou se o mesmo está sendo reconhecido. Então, para isso, digite o comando abaixo para realizar a listagem:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>fdisk <span class="nt">-l</span>
</pre></td></tr></tbody></table></code></pre></figure>

<div class="row imager" style="margin: 40px 0px;">
            <img class="img-fluid mx-auto d-block" src="/assets/images/posts/instalando-archlinux-com-criptografia-luks-e-lvm/fdisk_list.jpg" title="instalando-archlinux-com-criptografia-luks-e-lvm/fdisk_list.jpg" alt="instalando-archlinux-com-criptografia-luks-e-lvm/fdisk_list.jpg" />
          </div>

<p>Observe: Como estou utilizando o VirtualBox, repare que na listagem dos HD acima, só existe o <code class="highlighter-rouge">/dev/sda</code>, porem você pode ter mais de um HD/SSD, então cabe a você saber qual irá trabalhar. Neste caso iremos usar o <code class="highlighter-rouge">/dev/sda</code>.</p>

<p>Digite o comando abaixo para inicarmos o trabalho no disco <code class="highlighter-rouge">/dev/sda</code>.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>fdisk /dev/sda
</pre></td></tr></tbody></table></code></pre></figure>

<p>Nesse momento o <code class="highlighter-rouge">fdisk</code> já está pronto para trabalhar no disco <code class="highlighter-rouge">/dev/sda</code>. Ele é bem intuitivo. Já diz para você digitar <strong>m</strong> para ver as opções. Faça isso.</p>

<p>Se você viu as opções, observou que a opção <strong>n</strong> é de <strong>new</strong>, ou seja, criar novas partições, e é justamente isso que precisamos nesse momento, criar nossas partições, então mãos a obra.</p>

<h2 id="criando-a-partição-de-boot-com-fdisk">Criando a partição de Boot com fdisk</h2>

<blockquote>
  <p>Nota: A partição de boot deve ficar fora da partição criptografada com LUKS,
por isso devemos criar a mesma separada das demais.</p>
</blockquote>

<p>A primeira partição que iremos criar é a partição de Boot, então…</p>

<blockquote>
  <p>Digite: <strong>n</strong></p>
</blockquote>

<p>Depois irá perguntar para você o tipo de partição que você quer, primária ou extendida. Usamos a primeira opção, partição primária.</p>

<blockquote>
  <p>Digite: <strong>p</strong></p>
</blockquote>

<p>Agora, o <code class="highlighter-rouge">fdisk</code> irá pedir o numero da partição, por padrão, está com <strong>1</strong>.</p>

<blockquote>
  <p>Digite: <strong>1</strong> e dê Enter</p>
</blockquote>

<p>Nesse momento o <code class="highlighter-rouge">fdisk</code> irá imprimir o setor incial para você escolher para essa nova partição, por padrão, ele já seleciona o setor incial, então…</p>

<blockquote>
  <p>Apenas de <strong>Enter</strong></p>
</blockquote>

<p>Agora é a hora do <code class="highlighter-rouge">fdisk</code> definir o setor final, ou seja, nesse momento você terá que informar o tamanho que essa nova partição irá ter. Ele lhe dará a opção de definir a criação como Kbytes(K), MegaBytes(M) Gigabytes(G), etc. Vamos criar em MegaBytes (M).</p>

<p>Algo <strong>I M P O R T A N T E</strong> que você precisa saber, é que a partição de <strong>Boot</strong> não usa mais de que <strong>200MB</strong>. Então:</p>

<blockquote>
  <p>Digite: <strong>+200M</strong> e dê Enter</p>
</blockquote>

<p>Pronto, a partição foi criada, e o tipo da mesma como ‘Linux’(isso se você observou o print que o <code class="highlighter-rouge">fdisk</code> deixou na tela :D).
A partição de Boot tem que ser do tipo Linux, mas além de ser Linux, ela terá que ser bootável. Para isso usamos a opção <strong>a</strong> do <code class="highlighter-rouge">fdisk</code>, que deixa uma partição Ĺinux do tipo bootável. Então:</p>

<blockquote>
  <p>Digite: <strong>a</strong> e dê Enter</p>
</blockquote>

<p>Certo, a nova partição obtevo o tipo bootável, mas ainda está gravado em memória do <code class="highlighter-rouge">fdisk</code> essas mudanças, precisamos salvar essas mudanças fisicamente. Para isso usa-se a letra <strong>w</strong> de <strong>write</strong>. Então:</p>

<blockquote>
  <p>Digite: <strong>w</strong> e dê Enter</p>
</blockquote>

<p>Ao gravar, o <code class="highlighter-rouge">fdisk</code> irá se fechar automaticamente , isso pra que você possa verificar se realmente as mudanças (ou partições) foram concluídas. Para verficar, apenas de o comando abaixo:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>fdisk <span class="nt">-l</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Veja na imagem que existe uma nova partição do disco <code class="highlighter-rouge">/dev/sda</code>, e essa partição é a <code class="highlighter-rouge">/dev/sda1</code>. Então nossa partição do tipo Boot foi criada com sucesso! Yuupii! :pray:</p>

<div class="row imager" style="margin: 40px 0px;">
            <img class="img-fluid mx-auto d-block" src="/assets/images/posts/instalando-archlinux-com-criptografia-luks-e-lvm/list_boot_partition.jpg" title="instalando-archlinux-com-criptografia-luks-e-lvm/list_boot_partition.jpg" alt="instalando-archlinux-com-criptografia-luks-e-lvm/list_boot_partition.jpg" />
          </div>

<blockquote>
  <p>Lembrando que se você estiver usando um sistema com EFI, crie uma partição
do tipo EFI!</p>
</blockquote>

<h2 id="criando-partição-do-windows-com-fdisk">Criando partição do Windows com fdisk</h2>

<blockquote>
  <p>Nota: A partição do Windows não suporta criptografia LUKS, isso porque,
o LUKS só encarrega de gerenciar partições Linux. Então a partição Windows
terá que ser independente.</p>
</blockquote>

<p>Agora que você já sabe como criar partições com o <code class="highlighter-rouge">fdisk</code>, os passoas anteriores não precisam ser repetidos para as duas partições que nos resta, a de <strong>Windows</strong> e a do <strong>Linux</strong>.</p>

<p>Porém, algo <strong>I M P O R T A N T E</strong> que você precisa saber, é que toda vez que criamos uma partição nova, ela irá obter o tipo ‘Linux’ de inicio. Neste caso como é uma partição para Windows, e Windows utiliza <strong>NTFS</strong>, devemos editar o tipo dessa partição.</p>

<p>Você pode digitar <strong>m</strong> novamente para ver a letra que se aplica para deixar a partição em modo de edição, mas como sou bonzinho vou dizer, é a letra <strong>t</strong>, de <strong>type</strong>.</p>

<blockquote>
  <p>Digite: <strong>t</strong> e dê Enter</p>
</blockquote>

<p>O <code class="highlighter-rouge">fdisk</code> deixará sua partição em modo de edição, agora basta você escolher o tipo que essa partição vai ter, utilizando a própria sugestão do <code class="highlighter-rouge">fdisk</code>, onde pede para digitar <strong>L</strong> (em maíusculo) para listar os tipos de partições disponíveis.</p>

<blockquote>
  <p>Digite: <strong>L</strong> e dê Enter</p>
</blockquote>

<p>Nesse momento você verá a lista de tipos de partição, onde cada uma delas está sendo representada por um código, a partição de <strong>NTFS</strong> é o código <strong>86</strong>.</p>

<blockquote>
  <p>Digite: <strong>86</strong> e dê Enter</p>
</blockquote>

<p>Agora, simplesmente escreve essas mudaçãs como já aprendemos anteriormente com a opção <strong>w</strong>.</p>

<blockquote>
  <p>Digite: <strong>w</strong> e dê Enter</p>
</blockquote>

<h2 id="criando-partição-linux-lvm-com-fdisk">Criando partição “Linux LVM” com fdisk</h2>

<p>Como vamos trabalhar com LVM, o tipo da partição Linux, <strong>O B R I G A T Ó R I A M E N T E</strong>, tem que ser do tipo <em>‘Linux LVM’</em>. Então crie essa nova partição com o código: <strong>8e</strong>.</p>

<p>Chegamos ao final de criação de partições com <code class="highlighter-rouge">fdisk</code>, veja uma imagem de exemplo ficou:</p>

<div class="row imager" style="margin: 40px 0px;">
            <img class="img-fluid mx-auto d-block" src="/assets/images/posts/instalando-archlinux-com-criptografia-luks-e-lvm/list_all_partitions.jpg" title="instalando-archlinux-com-criptografia-luks-e-lvm/list_all_partitions.jpg" alt="instalando-archlinux-com-criptografia-luks-e-lvm/list_all_partitions.jpg" />
          </div>

<p>Memorize bem as seguintes partições abaixo, pois iremos utilizar elas mais pra frente:</p>

<ul>
  <li>Boot &gt; /dev/sda1</li>
  <li>Linux &gt; /dev/sda3</li>
</ul>

<h1 id="o-luks">O LUKS</h1>

<h2 id="conceitos-1">Conceitos</h2>

<p>Existe várias formadas de criptografar partições com LUKS. Selecionei 3(três) delas que achei interessante para levantar alguns conceitos, veja:</p>

<ul>
  <li>Criptografar a partição <strong>Home</strong> apenas com senha.</li>
  <li>Criptografar a partição <strong>Home</strong> com opção de keyfile e usar um pendrive com o mesmo Keyfile dentro para montar a partição <strong>Home</strong> no Linux.</li>
  <li>Criptografar a partição “Linux LVM” inteira, através de uma senha.</li>
</ul>

<p><strong>A primeira</strong> é interessante, deixamos todo sistema de arquivos sem criptografia, e quando o sistema for montar nossa partição <strong>Home</strong> , pedirá a senha. Porem, seus arquivos do sistema estarão expostos e existe muitas informações no sistema de arquivos que podem comprometer você. Então existe uma “brecha” de insegurança nessa opção. <br />
<strong>A segunda</strong> opção é a que eu menos recomendo, apensar de também ser interessante usar um pendrive para montar a <strong>home</strong>. Porem, se você criptografar somente a partição <strong>home</strong> e perder o pendrive com a keyfile (ou o pendrive queimar), por exemplo, você pode não conseguir iniciar o sistema, por depender dessa keyfile que não está disponível. E amiguinho, vai te dar <em>“dor de cabeça”</em>. <br />
<strong>A terceira</strong> opção, é a criptografia de todo o sistema Linux LVM, ela que iremos utilizar nesse tutorial. Talvez em um outro tutorial, eu explique como fazer uma criptografia da <strong>primeira</strong> e <strong>segunda</strong> opção.</p>

<blockquote>
  <p>Nota: Não tem como criptografar a partição de sistema de arquivos inteira
com LUKS através de um keyfile no pendrive, isso porque você está mantendo o
arquivo <strong>/etc/fstab</strong> criptografado também, e para um pendrive ser
iniciado, ele necessita do <strong>/etc/fstab</strong>. Isso seria possível se ter uma
partição apenas para o <strong>/etc</strong> e não criptografar ela. Mas pode te dar
trabalho ao fazer isso, então vamos usar a primeira opção mesmo.</p>
</blockquote>

<blockquote>
  <p><strong>Importante:</strong> <br />
Caso você use dual boot com Windows, você deve deixar para ambos UTC ou
LOCALTIME. Haverá conflito de hora se um S.O estiver um com UTC e outro com
LOCALTIME.</p>
</blockquote>

<p>Para deixar o Archlinux configurado como LOCALTIME, execute o comando abaixo:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nb">printf</span> <span class="s2">"0.0 0.0 0.0</span><span class="se">\n</span><span class="s2">0</span><span class="se">\n</span><span class="s2">LOCAL</span><span class="se">\n</span><span class="s2">"</span> <span class="o">&gt;</span> /etc/adjtime
</pre></td></tr></tbody></table></code></pre></figure>

<p>O aquivo <strong>/etc/adjtime</strong> é responsável por carregar o tipo da nossa hora (UTC ou LOCAL) na máquina. Atribuindo esse comando, irá deixar configurado para LOCALTIME.</p>

<h2 id="configurando-hostname">Configurando hostname</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nb">echo</span> <span class="s2">"archlinux"</span> <span class="o">&gt;</span> /etc/hostname
</pre></td></tr></tbody></table></code></pre></figure>

<p>Existe o comando <code class="highlighter-rouge">hostnamectl</code>, que você tambem pode alterar seu hostname futuramente. Dê um <code class="highlighter-rouge">hostnamectl --help</code> e veja as opções.</p>

<h2 id="habilitando-rede-cabeada-durante-o-boot">Habilitando rede cabeada durante o boot</h2>

<p>Se você utiliza rede cabeada, será necessário habilitar <a href="https://wiki.archlinux.org/index.php/Network_configuration_(Portugu%C3%AAs)#DHCP_durante_o_boot" target="_blank">DHCP durante o boot</a> da máquina para que você não precise ficar habilitando o mesmo quando já estiver no sistema.</p>

<p>Por padrão, no diretório <strong>/sys/class/net</strong> existe links simbólicos das interfaces de rede. Apenas de o comando <code class="highlighter-rouge">ls /sys/class/net</code> para listar.</p>

<div class="row imager" style="margin: 40px 0px;">
            <img class="img-fluid mx-auto d-block" src="/assets/images/posts/instalando-archlinux-com-criptografia-luks-e-lvm/list_iface_net.jpg" title="instalando-archlinux-com-criptografia-luks-e-lvm/list_iface_net.jpg" alt="instalando-archlinux-com-criptografia-luks-e-lvm/list_iface_net.jpg" />
          </div>

<p>Toda interface que começa com <code class="highlighter-rouge">enp</code> será a sua rede cabeada. Nesse caso a listada foi <code class="highlighter-rouge">enp0s3</code>. Então será ela que devemos habilitar durante o boot. Para isso executamos o seguinte comando:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>systemctl <span class="nb">enable </span>dhcpcd@enp0s3
</pre></td></tr></tbody></table></code></pre></figure>

<p>… ou simplesmente o comando:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>systemctl <span class="nb">enable </span>dhcpcd
</pre></td></tr></tbody></table></code></pre></figure>

<p>Leia sobre o <a href="https://wiki.archlinux.org/index.php/Systemd_(Portugu%C3%AAs)" target="_blank">Systemctl</a>, pois você pode utilizar muito ele em seu Archlinux.</p>

<h2 id="criando-um-usuário-padrão">Criando um usuário padrão</h2>

<p>Nunca é recomendável usar um sistema com o usuário <strong>root</strong>, pois pode comprometer a estrutura do seu <strong>sistema de arquivos</strong> fazendo com que o sistema fique inutilizável. O recomendável é ter um usuário padrão, então vamos criar um com o comando abaixo usando o <a href="https://wiki.archlinux.org/index.php/users_and_groups#User_management" target="_blank">useradd</a>:</p>

<h2 id="erro-aqui">Erro AQUI</h2>

<p>Vamos informar uma senha para este usuário agora:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>passwd &lt;NAMEUSER&gt;
</pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
  <p>NOTA: Onde está ‘&lt; NAMEUSER &gt;’ coloque o nome do usuário que você quer.</p>
</blockquote>

<h2 id="configurando-o-etcfstab">Configurando o /etc/fstab</h2>

<p>Lembra que criamos o <strong>/etc/fstab</strong> antes de iniciarmos no sistema base do Archlinux? Pois bem, agora precisamos fazer algumas alterações.</p>

<p>Por padrão o <strong>/etc/fstab</strong> já está funcional, mas vamos acrescentar algumas outras configurações. Essas são:</p>

<ul>
  <li>Adicionar a partição Windows para ser montada no boot (caso tenha Windows).</li>
  <li>Adiciona o reconhecimento do dispositivo CD/DVD.</li>
</ul>

<p>Vou utilizar o <strong>vim</strong> para edição, pois instalei ele lá nos <em>pacotes necessários</em>, lembra?! Você pode usar outro, como o <strong>nano</strong>.</p>

<p>Abra o arquivo:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>vim /etc/fstab
</pre></td></tr></tbody></table></code></pre></figure>

<p>Para deixar o arquivo em modo de edição no <strong>vim</strong>…</p>

<blockquote>
  <p>Digite: <strong>i</strong></p>
</blockquote>

<p>Posicione o ponteiro no final do arquivo e adicione essas linhas:</p>

<blockquote>
  <p>######## CD/DVD <br />
/dev/sr0  /media/cdrom0  udf,iso9660 user,noauto  0  0 <br />
######## Windows <br />
/dev/sda2 /mnt/windows  ntfs-3g defaults,user,rw,auto  0  0</p>
</blockquote>

<p>Saia do modo de edição com a tecla <strong>Esc</strong>, e …</p>

<blockquote>
  <p>Digite: <strong>:wq</strong></p>
</blockquote>

<p>Isso irá SALVAR e SAIR do <strong>vim</strong>.</p>

<p>Agora temos que criar a pasta e link simbólico onde será montados esses dispositivos. Para isso, execute os comandos:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre> <span class="nb">mkdir</span> /media/cdrom0
 <span class="nb">ln</span> <span class="nt">-s</span> /media/cdrom0 /media/cdrom
 <span class="nb">mkdir</span> /mnt/windows
</pre></td></tr></tbody></table></code></pre></figure>

<p>Pronto! Terminamos toda edição do <strong>/etc/fstab</strong>. Na próxima reinicialização da máquina, esses dispositivos já estarão montados.</p>

<h2 id="configurando-o-etcmkinitcpioconf">Configurando o /etc/mkinitcpio.conf</h2>

<p>O arquivo <strong>/etc/mkinitcpio.conf</strong> é responsável por configurar a imagem de boot. Dentro do <strong>/etc/mkinitcpio.conf</strong> você coloca valores que pode modificar a forma de como o Archlinux irá se comportar e carregar algumas funções.</p>

<p>Por padrão, quando instalamos o Archlinux, não precisamos alterar em nada neste arquivo, porem, como utilizamos LVM e criptografia, devemos fazer algumas mudanças.</p>

<p>Então, abra o arquivo com seu editor preferencial. Usarei o <strong>vim</strong> novamente:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>vim /etc/mkinitcpio.conf
</pre></td></tr></tbody></table></code></pre></figure>

<p>Ok, agora procure a variável <strong>HOOKS=”..”</strong>, vamos acrescentar alguns recursos a mais na mesma.</p>

<blockquote>
  <p>Nota: Se você observar os comentários logo acima de <strong>HOOKS=”…“</strong>, vai ver
que já nos dá uma dica de como devemos deixa-lá caso usamos criptografia e
LVM.</p>
</blockquote>

<p>Então vamos deixar assim:</p>

<blockquote>
  <p><strong>HOOKS</strong>=<strong>“</strong>base udev autodetect keymap <strong>encrypt lvm2</strong> modconf block
 filesystems keyboard fsck<strong>“</strong></p>
</blockquote>

<p>Se você reparou no arquivo original, viu que foi adicionado somente o <strong>encrypt</strong> e o <strong>lvm2</strong>.</p>

<p><strong>OBRIGATÓRIAMENTE</strong> tem que ser nessa ordem, mais precisamente depois de <strong>autodetect</strong>.</p>

<p><em>Já pode SALVAR e FECHAR o editor</em>.</p>

<p>Com o <strong>/etc/mkinitcpio.conf</strong> configurado, basta “subir” essas novas configurações, para isso, temos que executar o seguinte comando:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>mkinitcpio <span class="nt">-p</span> linux
</pre></td></tr></tbody></table></code></pre></figure>

<p>OK! Concluímos toda instalação e configuração do Archlinux. Agora vamos para a etapa do gerenciamento de boot.</p>

<h1 id="o-grub">O Grub</h1>

<h2 id="conceitos-2">Conceitos</h2>

<p>O Grub (<a href="https://wiki.archlinux.org/index.php/GRUB" target="_blank">English</a>/<a href="https://wiki.archlinux.org/index.php/GRUB_(Portugu%C3%AAs)#Instala.C3.A7.C3.A3o" target="_blank">Portuguese</a>) é um dos gerenciador de boot do Linux. Vamos utilizar o mesmo para gerenciar nosso boot.</p>

<h2 id="instalando-o-grub-no-sistema">Instalando o Grub no sistema</h2>

<p>Para instalarmos fazemos assim:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>pacman <span class="nt">-S</span> grub <span class="nt">--noconfirm</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Se utilizar um sistema com <a href="https://wiki.archlinux.org/index.php/GRUB#UEFI_systems" target="_blank">UEFI</a>, irá precisar de um pacote extra, o <strong>efibootmgr</strong>. Então instale assim:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>pacman <span class="nt">-S</span> grub efibootmgr <span class="nt">--noconfirm</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Caso não use UEFI, ignore o pacote <strong>efibootmgr</strong>.</p>

<p>Se utilizar o Windows como dual boot, vai precisar usar o pacote <strong>os-prober</strong>, então ficaria assim:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>pacman <span class="nt">-S</span> grub os-prober <span class="nt">--noconfirm</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Caso não utilize o Windows com dual boot, ignore o pacote <strong>os-prober</strong>.</p>

<h2 id="configurando-o-grub">Configurando o Grub</h2>

<p>Por padrão, quando instalamos o Archlinux sem criptografia e sem LVM, não necessitamos editar o arquivo de configuração Grub, porém, como utilizamos, iremos fazer algumas mudanças necessárias.</p>

<p>Novamente usando o <strong>vim</strong>, abra o arquivo <strong>/etc/default/grub</strong>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>vim /etc/default/grub
</pre></td></tr></tbody></table></code></pre></figure>

<p>Agora deixe a variável <strong>GRUB_CMDLINE_LINUX=”“</strong> da seguinte forma:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">"cryptdevice=/dev/sda3:linux root=/dev/mapper/linux-archlinux"</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Observe que em <strong>cryptdevice</strong> utilizamos a partição <strong>/dev/sda3</strong> que é a nossa <em>Linux LVM</em>. Logo a frente informamos o “Volume Group (VG)”, o <strong>linux</strong>. Em <strong>root</strong> informamos nosso “Logical Volume (LV)” do nosso <strong>sistema de arquivos</strong>, o <strong>/dev/mapper/linux-archlinux</strong>.</p>

<p>Agora adicione as seguintes linhas (ou configure-as caso já exista), assim:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nv">GRUB_PRELOAD_MODULES</span><span class="o">=</span><span class="s2">"lvm"</span>
<span class="nv">GRUB_ENABLE_CRYPTODISK</span><span class="o">=</span>y
<span class="nv">GRUB_DISABLE_SUBMENU</span><span class="o">=</span>y
</pre></td></tr></tbody></table></code></pre></figure>

<p>A linha <em>GRUB_DISABLE_SUBMENU=y</em>, é para caso você estiver utilizando o VirtualBox, pois é necessário ter para não dar erro de boot no Grub conforme alguns testes que fiz.</p>

<p>Pronto! SALVE as alterações e FECHE o editor de texto.</p>

<h2 id="gerando-as-configurações">Gerando as configurações</h2>

<p>Com toda configuração realizada, vamos levantar as mesmas para nosso sistema. Execute o comando abaixo:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>grub-mkconfig <span class="nt">-o</span> /boot/grub/grub.cfg
</pre></td></tr></tbody></table></code></pre></figure>

<p>No momento, o Grub está instalado apenas no sistema operacional, mas não na unidade, o que veremos logo a seguir.</p>

<h2 id="instalando-o-grub-na-unidade">Instalando o Grub na unidade</h2>

<p>Agora precisamos instalar de fato o Grub e toda configuração do mesmo que realizamos na unidade <strong>/dev/sda</strong>. Para isso usamos o comando:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>grub-install /dev/sda
</pre></td></tr></tbody></table></code></pre></figure>

<p>Se possua um sistema <a href="https://wiki.archlinux.org/index.php/GRUB#UEFI_systems" target="_blank">UEFI</a>, faça dessa maneira:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>grub-install <span class="nt">--target</span><span class="o">=</span>x86_64-efi <span class="nt">--efi-directory</span><span class="o">=</span>/boot <span class="nt">--bootloader-id</span><span class="o">=</span>grub
</pre></td></tr></tbody></table></code></pre></figure>

<p>Se não apresentar erros, concluímos toda nossa instalação do Arclinux criptografado com LVM.</p>

<h1 id="reiniciando-o-sistema">Reiniciando o sistema</h1>

<p>Basta executar os comandos abaixo ordenadamente para sair do ambiente de instalação, desmontar as unidades e reiniciar o sistema:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nb">exit
</span>umount <span class="nt">-R</span> /mnt
systemctl reboot
</pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
  <p>Nota: Se estiver instalando com VirtualBox, não esquece de tirar a mídia do
Archlinux, caso contrário em vez do Archlinux instalado iniciar, será a
mídia que fará essa função.</p>
</blockquote>

<p>Agora, toda vez que iniciar o sistema (antes mesmo do boot), a senha de criptografia irá ser requerida, com isso, é interessante deixar o login automático para não ter que digitar senha no mesmo também. Para isso, recomendo ler <a href="https://wiki.archlinux.org/index.php/Getty" target="_blank">Getty</a> no wiki do Archlinux.</p>

<h1 id="conclusão">Conclusão</h1>

<p>Me esforcei para fazer bem detalhadamente, bem intuitivo, para pessoas que estão començando possam compreender facilmente. Não é complicado a instalação, pois a extensão desde tutorial é válido mais pelos comentários, mas os comandos são poucos.</p>

<p>Sempre é recomendável seguir a documentação de qualquer software ou sistema operacional. A maioria dos comandos também existe documentação, o chamado <strong>man</strong>. Para usar, simplesmente digite no console: <code class="highlighter-rouge">man &lt;comando&gt;</code> , exemplo: <code class="highlighter-rouge">man fdisk</code>.</p>

<p>Explorar e aprender nunca é exagero. Até a próxima! :)</p>

:ET